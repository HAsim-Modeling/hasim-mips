#!/bin/sh

##############################################################
#
# Setup all tests for smips
#
# Usage: setup-all-tests-smips <srcdir> <destdir>
#
# Setup benchmark to run in <destdir>
#
##############################################################

bmark_dir=$(awb-resolver -config=benchmarkdir)/hasim/smips
if [ ! -e "$bmark_dir" ]; then
  echo "Error: $0 - smips benchmark dirrectory ($bmark_dir) does not exist"
  exit 1;
fi

# 1. Build Benchmark in $destdir
# 2. Create $destdir/run

#if [ $# -ne 2 ]; then
#   echo Usage $0 "<srcdir> <destdir>"
#   echo $*
#   exit 1
#fi

srcdir=$1
destdir=$2
shift 2

# echo "BMARK: $bmark"
# echo "SRC: $srcdir"

echo "Go to $destdir"
cd $destdir

echo "Creating simlinks"
mkdir -p program

/bin/ln -f -s $bmark_dir/instruction-tests/*.smips.vmh program
/bin/ln -f -s $srcdir/Makefile.tests program

#echo "Making benchmark"
#make -C program asm_tests_vmh

echo "Creating run script"
echo '#!/bin/sh'                                                  > run
echo "# benchmark run script generated by $0"                    >> run 
for i in `seq 1 $#`; 
do
  rundir=$1.smips.rundir
  mkdir -p $rundir
  /bin/ln -f -s ../program/$1.smips.vmh $rundir/program.vmh
  /bin/ln -f -s ../../../pm/simv $rundir/simv
  if [ -e ../../../pm/simv.daidir ]; then
    /bin/ln -f -s ../../../pm/simv.daidir $rundir/simv.daidir
  fi
  echo "cd $rundir"                                              >> run
  echo "echo $rundir"                                            >> run
  echo "./simv | tee $1.smips.out"                               >> run
  echo "sort hasim_events.out -o hasim_events.out"               >> run
  echo "cd .."                                                   >> run
  echo ""                                                        >> run
  shift 1
done

chmod +x run

exit 0
