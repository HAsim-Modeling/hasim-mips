#!/bin/sh

##############################################################
#
# Benchmark setup for smips
#
# Usage: setup-bmark-smips <srcdir> <destdir> <bmark>
#
# Setup benchmark to run in <destdir>
#
##############################################################

bmark_dir=$(awb-resolver -config=benchmarkdir)/hasim/smips
if [ ! -e "$bmark_dir" ]; then
  echo "Error: $0 - smips benchmark dirrectory ($bmark_dir) does not exist"
  exit 1;
fi

# 1. Build Benchmark in $destdir
# 2. Create $destdir/run

if [ $# -ne 3 ]; then
   echo Usage $0 "<srcdir> <destdir> <bmark>"
   echo $*
   exit 1
fi

srcdir=$1
destdir=$2
bmark=$3

# echo "BMARK: $bmark"
# echo "SRC: $srcdir"
# echo "DST: $destdir"

echo "Go to $destdir"
cd $destdir

echo "Creating simlinks"

if [ -e ../../pm/simx ]; then
    /bin/ln -f -s ../../pm/simx .
    # Create link to top-level .bsc directory
    /bin/ln -f -s ../../pm/.bsc .
    progname="./simx"
else
    /bin/ln -f -s ../../pm/simv .
    progname="./simv"
fi

if [ -e ../../pm/simv.daidir ]; then
    /bin/ln -f -s ../../pm/simv.daidir
fi


mkdir -p program
/bin/ln -f -s $bmark_dir/$bmark/* program/
/bin/ln -f -s $srcdir/Makefile.bmarks program/Makefile

#echo "Making benchmark"
#make -C program $bmark.smips.vmh

echo "Creating run script"
echo '#!/bin/sh'                                                                   > run
echo "# benchmark run script generated by $0"                                     >> run
echo "/bin/ln -f -s program/$bmark.smips.vmh program.vmh"                         >> run
echo "$progname \$* | tee $bmark.smips.out"                                       >> run
echo "if [ -e \"hasim_events.out\" ]"                                             >> run
echo "then"                                                                       >> run
echo "  sort hasim_events.out -o hasim_events.out"                                >> run
echo "fi"                                                                         >> run


chmod +x run

exit 0
